<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GATE EC - Mock Test</title>

  <style>
    :root{
      --blue1:#0b1f4d;
      --blue2:#0f3d91;
      --blue3:#1e74ff;
      --bg:#f4f6fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --shadow: 0 10px 30px rgba(15,23,42,.08);
      --radius:18px;
      --ok:#16a34a;
      --bad:#dc2626;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:var(--bg);
      color:var(--text);
    }

    .topbar{
      position:sticky;
      top:0;
      z-index:50;
      background: linear-gradient(90deg, var(--blue1), var(--blue2), var(--blue3));
      padding:14px 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,.12);
    }
    .topbar-row{
      max-width:1000px;
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .title{
      color:#fff;
      font-weight:900;
      letter-spacing:.4px;
      text-align:center;
      flex:1;
      font-size:18px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .btn{
      border:none;
      cursor:pointer;
      padding:10px 14px;
      border-radius:999px;
      font-weight:800;
      background: rgba(255,255,255,.92);
      color:#0b1f4d;
      box-shadow: 0 6px 14px rgba(0,0,0,.15);
      min-width:96px;
    }
    .btn:active{transform:scale(.98)}
    .btn.dark{
      background: rgba(15,23,42,.92);
      color:#fff;
    }
    .btn.ghost{
      background: rgba(255,255,255,.15);
      color:#fff;
      box-shadow:none;
      min-width:auto;
    }

    .container{
      max-width:1000px;
      margin:18px auto;
      padding:0 12px 60px;
    }
    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      margin-bottom:14px;
    }
    .pill{
      display:inline-block;
      padding:6px 12px;
      border-radius:999px;
      background:#eef2ff;
      color:#3730a3;
      font-weight:800;
      font-size:12px;
      margin-bottom:8px;
    }
    .h1{
      font-size:28px;
      font-weight:900;
      margin:0 0 4px;
    }
    .sub{
      color:var(--muted);
      margin:0;
      font-weight:650;
    }
    .list{
      display:flex;
      flex-direction:column;
      gap:12px;
      margin-top:12px;
    }
    .rowcard{
      background:#fff;
      border-radius:16px;
      padding:14px;
      box-shadow: 0 10px 25px rgba(15,23,42,.06);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .left{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
    }
    .big{
      font-weight:900;
      font-size:18px;
      display:flex;
      align-items:center;
      gap:10px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .tag{
      font-size:12px;
      font-weight:900;
      padding:6px 10px;
      border-radius:999px;
      background:#eef2ff;
      color:#1e3a8a;
      flex-shrink:0;
    }
    .small{
      color:var(--muted);
      font-size:13px;
      margin:0;
      font-weight:650;
    }
    .action{
      border:none;
      cursor:pointer;
      padding:10px 14px;
      border-radius:999px;
      font-weight:900;
      background:#eaf2ff;
      color:#0b3b91;
      min-width:110px;
    }
    .action:active{transform:scale(.98)}

    .hidden{display:none !important;}
    .loading{
      display:flex;
      align-items:center;
      gap:10px;
      color:var(--muted);
      font-weight:800;
      padding:10px 0;
    }
    .divider{
      height:1px;
      background:#e5e7eb;
      margin:12px 0;
    }
    .topicBox{
      background:#f8fafc;
      border:1px solid #e5e7eb;
      border-radius:16px;
      padding:14px;
    }
    ul{
      margin:8px 0 0 18px;
      color:#334155;
      font-weight:700;
    }

    .qbox{
      border:1px solid #e5e7eb;
      border-radius:16px;
      padding:14px;
      background:#fff;
      margin-top:12px;
    }
    .qtitle{
      font-weight:900;
      margin:0 0 10px;
    }
    .opt{
      display:block;
      width:100%;
      text-align:left;
      padding:12px;
      border-radius:14px;
      border:1px solid #e5e7eb;
      background:#f8fafc;
      margin:8px 0;
      cursor:pointer;
      font-weight:800;
    }
    .opt.correct{
      border-color:var(--ok);
      background:#dcfce7;
    }
    .opt.wrong{
      border-color:var(--bad);
      background:#fee2e2;
    }
    .toast{
      margin-top:10px;
      font-weight:900;
    }
    .mutedNote{
      font-size:12px;
      color:var(--muted);
      margin-top:6px;
      font-weight:700;
    }

    .statRow{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      margin-top:12px;
    }
    .stat{
      flex:1;
      min-width:160px;
      background:#f8fafc;
      border:1px solid #e5e7eb;
      border-radius:16px;
      padding:12px;
    }
    .stat .k{color:var(--muted); font-weight:800; font-size:12px;}
    .stat .v{font-weight:950; font-size:22px; margin-top:4px;}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-row">
      <button class="btn" id="btnHome">Home</button>
      <div class="title">GATE EC - Mock Test</div>
      <button class="btn" id="btnDash">Dashboard</button>
      <button class="btn ghost" id="btnAuth">Login</button>
    </div>
  </div>

  <div class="container">

    <!-- HOME -->
    <div id="screenHome">
      <div class="card">
        <div class="pill">Beginner Friendly</div>
        <div class="h1">Select Subject</div>
        <p class="sub">Subject → Topic → Overview → Quiz</p>
      </div>

      <div class="card">
        <div class="loading" id="homeLoading">⏳ Loading subjects...</div>
        <div class="list" id="subjectList"></div>
      </div>
    </div>

    <!-- TOPICS -->
    <div id="screenTopics" class="hidden">
      <div class="card">
        <div class="pill" id="topicsPill">Subject</div>
        <div class="h1" id="topicsTitle">Topics</div>
        <p class="sub">Select a topic to view overview + quiz.</p>
        <div class="divider"></div>
        <button class="btn dark" id="btnBackToHome">⬅ Back</button>
      </div>

      <div class="card">
        <div class="loading hidden" id="topicsLoading">⏳ Loading topics...</div>
        <div class="list" id="topicsList"></div>
      </div>
    </div>

    <!-- QUIZ -->
    <div id="screenQuiz" class="hidden">
      <div class="card">
        <div class="pill" id="quizPill">Topic</div>
        <div class="h1" id="quizTitle">Topic</div>
        <p class="sub" id="quizSubtitle">Overview + subtopics + quiz questions.</p>
        <div class="divider"></div>
        <button class="btn dark" id="btnBackToTopics">⬅ Back</button>
      </div>

      <div class="card">
        <div class="topicBox">
          <div style="font-weight:950;">Overview</div>
          <div id="topicOverview" style="margin-top:6px; color:#334155; font-weight:700;"></div>

          <div style="margin-top:12px; font-weight:950;">Subtopics</div>
          <ul id="topicSubtopics"></ul>
        </div>

        <div class="divider"></div>

        <div class="loading hidden" id="quizLoading">⏳ Loading questions...</div>
        <div id="quizArea"></div>

        <div class="divider"></div>
        <button class="btn dark" id="btnFinishQuiz" style="width:100%;">Finish & Save Attempt</button>
        <div class="mutedNote">Attempt will be saved only if you are logged in.</div>
      </div>
    </div>

    <!-- DASHBOARD -->
    <div id="screenDashboard" class="hidden">
      <div class="card">
        <div class="pill">User Activity</div>
        <div class="h1">Dashboard</div>
        <p class="sub" id="dashSub">Login to track attempts and scores.</p>

        <div class="statRow">
          <div class="stat">
            <div class="k">Total Attempts</div>
            <div class="v" id="statAttempts">0</div>
          </div>
          <div class="stat">
            <div class="k">Best Score</div>
            <div class="v" id="statBest">0</div>
          </div>
          <div class="stat">
            <div class="k">Last Score</div>
            <div class="v" id="statLast">0</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="loading hidden" id="dashLoading">⏳ Loading attempts...</div>
        <div class="list" id="attemptList"></div>
      </div>
    </div>

    <!-- LOGIN -->
    <div id="screenLogin" class="hidden">
      <div class="card">
        <div class="pill">Account</div>
        <div class="h1">Login</div>
        <p class="sub">Google Login (best for mobile + GitHub Pages)</p>

        <div class="divider"></div>
        <button class="btn" id="btnGoogleLogin" style="width:100%;">Continue with Google</button>
        <div class="mutedNote">⚠️ If “disallowed_useragent” error comes, open in Chrome browser.</div>

        <div class="divider"></div>
        <button class="btn dark" id="btnBackFromLogin" style="width:100%;">⬅ Back</button>

        <div style="margin-top:10px;font-weight:900;" id="loginStatus"></div>
      </div>
    </div>

  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      getFirestore, collection, getDocs, query, where, orderBy, limit, addDoc
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC_f6lvDO9LeSE22kv4HIhWLj846bmRla8",
      authDomain: "gate-ec-mock.firebaseapp.com",
      projectId: "gate-ec-mock",
      storageBucket: "gate-ec-mock.firebasestorage.app",
      messagingSenderId: "668980846025",
      appId: "1:668980846025:web:a960f983f2e6311fad1c18"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Screens
    const screenHome = document.getElementById("screenHome");
    const screenTopics = document.getElementById("screenTopics");
    const screenQuiz = document.getElementById("screenQuiz");
    const screenDashboard = document.getElementById("screenDashboard");
    const screenLogin = document.getElementById("screenLogin");

    // Header buttons
    const btnHome = document.getElementById("btnHome");
    const btnDash = document.getElementById("btnDash");
    const btnAuth = document.getElementById("btnAuth");

    // Home
    const homeLoading = document.getElementById("homeLoading");
    const subjectList = document.getElementById("subjectList");

    // Topics
    const topicsLoading = document.getElementById("topicsLoading");
    const topicsList = document.getElementById("topicsList");
    const topicsTitle = document.getElementById("topicsTitle");
    const topicsPill = document.getElementById("topicsPill");
    const btnBackToHome = document.getElementById("btnBackToHome");

    // Quiz
    const quizLoading = document.getElementById("quizLoading");
    const quizTitle = document.getElementById("quizTitle");
    const quizPill = document.getElementById("quizPill");
    const btnBackToTopics = document.getElementById("btnBackToTopics");
    const topicOverview = document.getElementById("topicOverview");
    const topicSubtopics = document.getElementById("topicSubtopics");
    const quizArea = document.getElementById("quizArea");
    const btnFinishQuiz = document.getElementById("btnFinishQuiz");

    // Dashboard
    const dashSub = document.getElementById("dashSub");
    const dashLoading = document.getElementById("dashLoading");
    const attemptList = document.getElementById("attemptList");
    const statAttempts = document.getElementById("statAttempts");
    const statBest = document.getElementById("statBest");
    const statLast = document.getElementById("statLast");

    // Login
    const btnGoogleLogin = document.getElementById("btnGoogleLogin");
    const btnBackFromLogin = document.getElementById("btnBackFromLogin");
    const loginStatus = document.getElementById("loginStatus");

    // State
    let currentUser = null;
    let currentSubject = null;
    let currentTopic = null;

    let totalCorrect = 0;
    let totalQuestions = 0;

    function hideAll(){
      screenHome.classList.add("hidden");
      screenTopics.classList.add("hidden");
      screenQuiz.classList.add("hidden");
      screenDashboard.classList.add("hidden");
      screenLogin.classList.add("hidden");
    }

    function go(screen){
      hideAll();
      if(screen === "home") screenHome.classList.remove("hidden");
      if(screen === "topics") screenTopics.classList.remove("hidden");
      if(screen === "quiz") screenQuiz.classList.remove("hidden");
      if(screen === "dashboard") screenDashboard.classList.remove("hidden");
      if(screen === "login") screenLogin.classList.remove("hidden");
    }

    // Subjects list
    const SUBJECTS = [
      {name:"General Aptitude", code:"GA"},
      {name:"Engineering Mathematics", code:"EM"},
      {name:"Network Theory", code:"NT"},
      {name:"Electronic Devices", code:"EDC"},
      {name:"Analog Circuits", code:"AN"},
      {name:"Digital Circuits", code:"DC"},
      {name:"Control Systems", code:"CS"},
      {name:"Communications", code:"COMM"},
      {name:"Electromagnetics", code:"EMFT"},
      {name:"Signals & Systems", code:"SS"},
    ];

    function renderSubjects(){
      homeLoading.classList.add("hidden");
      subjectList.innerHTML = "";

      SUBJECTS.forEach(s=>{
        const div = document.createElement("div");
        div.className = "rowcard";
        div.innerHTML = `
          <div class="left">
            <div class="big">${s.name} <span class="tag">${s.code}</span></div>
            <p class="small">Topics will load from Firebase</p>
          </div>
          <button class="action">Open</button>
        `;
        div.querySelector(".action").addEventListener("click", ()=>{
          currentSubject = s.code;
          go("topics");
          loadTopics(s.code);
        });
        subjectList.appendChild(div);
      });
    }

    async function loadTopics(subjectCode){
      topicsLoading.classList.remove("hidden");
      topicsList.innerHTML = "";
      topicsPill.textContent = subjectCode;
      topicsTitle.textContent = "Topics";

      try{
        const qRef = query(collection(db,"topics"), where("subject","==",subjectCode), orderBy("topic"));
        const snap = await getDocs(qRef);

        topicsLoading.classList.add("hidden");

        if(snap.empty){
          topicsList.innerHTML = `
            <div class="rowcard">
              <div class="left">
                <div class="big">No topics found</div>
                <p class="small">Add docs in Firestore collection <b>topics</b> for subject="${subjectCode}"</p>
              </div>
            </div>
          `;
          return;
        }

        snap.forEach(doc=>{
          const t = doc.data();
          const topicName = t.topic || "Unknown Topic";
          const overview = t.overview || "No overview added yet.";

          const div = document.createElement("div");
          div.className = "rowcard";
          div.innerHTML = `
            <div class="left">
              <div class="big">${topicName}</div>
              <p class="small">${overview}</p>
            </div>
            <button class="action">Start</button>
          `;

          div.querySelector(".action").addEventListener("click", ()=>{
            currentTopic = topicName;
            go("quiz");
            loadTopicAndQuestions(subjectCode, topicName);
          });

          topicsList.appendChild(div);
        });

      }catch(err){
        topicsLoading.classList.add("hidden");
        topicsList.innerHTML = `
          <div class="rowcard">
            <div class="left">
              <div class="big">Error loading topics</div>
              <p class="small">${err.message}</p>
            </div>
          </div>
        `;
      }
    }

    async function loadTopicAndQuestions(subjectCode, topicName){
      quizLoading.classList.remove("hidden");
      quizArea.innerHTML = "";
      totalCorrect = 0;
      totalQuestions = 0;

      quizPill.textContent = subjectCode + " • " + topicName;
      quizTitle.textContent = topicName;

      // Topic overview
      topicOverview.textContent = "Loading...";
      topicSubtopics.innerHTML = "";

      try{
        const tq = query(collection(db,"topics"), where("subject","==",subjectCode), where("topic","==",topicName), limit(1));
        const ts = await getDocs(tq);

        if(!ts.empty){
          const data = ts.docs[0].data();
          topicOverview.textContent = data.overview || "No overview added.";
          const subs = Array.isArray(data.subtopics) ? data.subtopics : [];
          if(subs.length===0){
            const li = document.createElement("li");
            li.textContent = "No subtopics added.";
            topicSubtopics.appendChild(li);
          } else {
            subs.forEach(x=>{
              const li = document.createElement("li");
              li.textContent = x;
              topicSubtopics.appendChild(li);
            });
          }
        } else {
          topicOverview.textContent = "Topic overview not found.";
        }
      }catch(e){
        topicOverview.textContent = "Error: " + e.message;
      }

      // Questions
      try{
        const qRef = query(collection(db,"questions"), where("subject","==",subjectCode), where("topic","==",topicName), limit(50));
        const snap = await getDocs(qRef);

        quizLoading.classList.add("hidden");

        if(snap.empty){
          quizArea.innerHTML = `
            <div class="qbox">
              <div class="qtitle">No questions found</div>
              <p class="small">Add questions in Firestore collection <b>questions</b>.</p>
            </div>
          `;
          totalQuestions = 0;
          return;
        }

        const questions = [];
        snap.forEach(d=>questions.push(d.data()));

        totalQuestions = questions.length;

        questions.forEach((q, i)=>{
          const box = document.createElement("div");
          box.className = "qbox";

          const title = document.createElement("div");
          title.className = "qtitle";
          title.textContent = `Q${i+1}. ${q.question || "No question text"}`;
          box.appendChild(title);

          const opts = Array.isArray(q.options) ? q.options : [];
          const ansIndex = Number(q.answer);

          const toast = document.createElement("div");
          toast.className = "toast";

          opts.forEach((op, idx)=>{
            const b = document.createElement("button");
            b.className = "opt";
            b.textContent = op;

            b.addEventListener("click", ()=>{
              box.querySelectorAll(".opt").forEach(x=>x.disabled=true);

              if(idx === ansIndex){
                b.classList.add("correct");
                toast.textContent = "✅ Correct";
                totalCorrect++;
              } else {
                b.classList.add("wrong");
                toast.textContent = "❌ Wrong";
                const correctBtn = box.querySelectorAll(".opt")[ansIndex];
                if(correctBtn) correctBtn.classList.add("correct");
              }
            });

            box.appendChild(b);
          });

          box.appendChild(toast);
          quizArea.appendChild(box);
        });

      }catch(err){
        quizLoading.classList.add("hidden");
        quizArea.innerHTML = `
          <div class="qbox">
            <div class="qtitle">Error loading questions</div>
            <p class="small">${err.message}</p>
          </div>
        `;
      }
    }

    // Save attempt (A)
    async function saveAttempt(){
      if(!currentUser){
        alert("Login first to save attempt in Dashboard.");
        return;
      }
      if(totalQuestions === 0){
        alert("No questions attempted.");
        return;
      }

      const attempt = {
        subject: currentSubject,
        topic: currentTopic,
        score: totalCorrect,
        total: totalQuestions,
        percent: Math.round((totalCorrect/totalQuestions)*100),
        time: Date.now()
      };

      try{
        const ref = collection(db, "users", currentUser.uid, "attempts");
        await addDoc(ref, attempt);
        alert("✅ Attempt saved!");
      }catch(err){
        alert("❌ Save failed: " + err.message);
      }
    }

    btnFinishQuiz.addEventListener("click", saveAttempt);

    // Dashboard load attempts
    async function loadDashboard(){
      go("dashboard");
      attemptList.innerHTML = "";
      statAttempts.textContent = "0";
      statBest.textContent = "0";
      statLast.textContent = "0";

      if(!currentUser){
        dashSub.textContent = "Login to track attempts and scores.";
        return;
      }

      dashSub.textContent = "Showing your recent attempts (latest 20).";
      dashLoading.classList.remove("hidden");

      try{
        const ref = collection(db, "users", currentUser.uid, "attempts");
        const qRef = query(ref, orderBy("time","desc"), limit(20));
        const snap = await getDocs(qRef);

        dashLoading.classList.add("hidden");

        if(snap.empty){
          attemptList.innerHTML = `
            <div class="rowcard">
              <div class="left">
                <div class="big">No attempts yet</div>
                <p class="small">Finish a quiz and click “Save Attempt”.</p>
              </div>
            </div>
          `;
          return;
        }

        const attempts = [];
        snap.forEach(d=>attempts.push(d.data()));

        statAttempts.textContent = attempts.length;
        statLast.textContent = attempts[0].score + "/" + attempts[0].total;
        statBest.textContent = Math.max(...attempts.map(a=>a.score)) + "";

        attempts.forEach(a=>{
          const div = document.createElement("div");
          div.className = "rowcard";
          const dt = new Date(a.time);
          div.innerHTML = `
            <div class="left">
              <div class="big">${a.subject} • ${a.topic}</div>
              <p class="small">Score: <b>${a.score}/${a.total}</b> (${a.percent}%) • ${dt.toLocaleString()}</p>
            </div>
            <span class="tag">${a.percent}%</span>
          `;
          attemptList.appendChild(div);
        });

      }catch(err){
        dashLoading.classList.add("hidden");
        attemptList.innerHTML = `
          <div class="rowcard">
            <div class="left">
              <div class="big">Dashboard error</div>
              <p class="small">${err.message}</p>
            </div>
          </div>
        `;
      }
    }

    // Auth
    function updateAuthUI(){
      if(currentUser){
        btnAuth.textContent = "Logout";
      } else {
        btnAuth.textContent = "Login";
      }
    }

    onAuthStateChanged(auth, (user)=>{
      currentUser = user;
      updateAuthUI();
    });

    btnAuth.addEventListener("click", async ()=>{
      if(currentUser){
        await signOut(auth);
        alert("Logged out");
        go("home");
      } else {
        go("login");
      }
    });

    btnGoogleLogin.addEventListener("click", async ()=>{
      loginStatus.textContent = "⏳ Opening Google login...";
      try{
        const provider = new GoogleAuthProvider();
        await signInWithPopup(auth, provider);
        loginStatus.textContent = "✅ Logged in!";
        go("home");
      }catch(err){
        loginStatus.textContent = "❌ Login failed: " + err.message;
      }
    });

    // Buttons
    btnHome.addEventListener("click", ()=> go("home"));
    btnDash.addEventListener("click", loadDashboard);

    btnBackFromLogin.addEventListener("click", ()=> go("home"));
    btnBackToHome.addEventListener("click", ()=> go("home"));
    btnBackToTopics.addEventListener("click", ()=>{
      go("topics");
      if(currentSubject) loadTopics(currentSubject);
    });

    // Start
    renderSubjects();
    go("home");
  </script>
</body>
</html>