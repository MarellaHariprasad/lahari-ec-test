<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>GATE EC Mock Test</title>

<style>
  :root{
    --blue1:#041a3a;
    --blue2:#0b3c91;
    --blue3:#2e7bff;
    --bg:#f4f6fb;
    --card:#ffffff;
    --text:#111827;
    --muted:#6b7280;
    --danger:#d90429;
    --ok:#0a7d2f;
    --shadow:0 10px 30px rgba(0,0,0,.08);
    --radius:16px;
  }

  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    background:var(--bg);
    color:var(--text)
  }

  header{
    background:radial-gradient(circle at center, #2e7bff 0%, #0b3c91 45%, #041a3a 100%);
    color:#fff;
    padding:12px 14px;
    position:sticky;
    top:0;
    z-index:10;
    cursor:pointer;
    box-shadow:0 6px 16px rgba(0,0,0,.12);
  }

  .headerWrap{
    max-width:980px;
    margin:0 auto;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }

  .headerTitle{
    flex:1;
    text-align:center;
    font-weight:800;
    letter-spacing:.4px;
    user-select:none;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  .headerLeft, .headerRight{
    display:flex;
    gap:8px;
    min-width:120px;
  }

  .headerLeft{justify-content:flex-start;}
  .headerRight{justify-content:flex-end;}

  .headerBtn{
    padding:8px 12px;
    border-radius:999px;
    border:none;
    cursor:pointer;
    font-weight:800;
    background:#e7efff;
    color:#0b3c91;
    font-size:13px;
    box-shadow:0 4px 10px rgba(0,0,0,.08);
  }

  .container{
    padding:14px;
    max-width:980px;
    margin:0 auto
  }

  .card{
    background:var(--card);
    padding:14px;
    margin:12px 0;
    border-radius:var(--radius);
    box-shadow:var(--shadow)
  }

  .row{display:flex;gap:12px;flex-wrap:wrap}
  .col{flex:1;min-width:220px}

  .btn{
    background:var(--blue2);
    color:#fff;
    border:none;
    padding:10px 14px;
    border-radius:12px;
    cursor:pointer;
    font-weight:750
  }

  .btn:active{transform:scale(.98)}
  .btn.secondary{background:#111827}
  .btn.light{background:#e7efff;color:#0b3c91}
  .btn.danger{background:var(--danger)}

  .pill{
    display:inline-block;
    padding:6px 10px;
    border-radius:999px;
    background:#eef2ff;
    color:#3730a3;
    font-size:12px;
    font-weight:800
  }

  .muted{color:var(--muted);font-size:13px;line-height:1.4}

  .topbar{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    flex-wrap:wrap
  }

  .timer{color:var(--danger);font-weight:900}

  .qbox{font-size:15px;line-height:1.5}

  .option{
    border:1px solid #d1d5db;
    padding:12px;
    margin:8px 0;
    border-radius:12px;
    cursor:pointer;
    background:#fff
  }

  .option.selected{background:#dbe6ff;border-color:#2e7bff}

  .nav{
    display:flex;
    justify-content:space-between;
    gap:10px;
    margin-top:12px;
    flex-wrap:wrap
  }

  .gridQ{
    display:grid;
    grid-template-columns:repeat(10, 1fr);
    gap:6px;
    margin-top:10px
  }

  .qnum{
    text-align:center;
    padding:8px;
    border-radius:10px;
    background:#f3f4f6;
    font-weight:800;
    cursor:pointer;
    font-size:12px
  }

  .qnum.answered{background:#d1fae5}
  .qnum.current{outline:2px solid #2563eb}

  .loading{display:flex;gap:10px;align-items:center}
  .dot{width:10px;height:10px;border-radius:50%;background:#2e7bff;animation:b 1s infinite}
  .dot:nth-child(2){animation-delay:.2s}
  .dot:nth-child(3){animation-delay:.4s}
  @keyframes b{0%,100%{opacity:.2}50%{opacity:1}}

  .warn{
    color:#92400e;
    background:#fffbeb;
    border:1px solid #fcd34d;
    padding:10px;
    border-radius:12px
  }

  .ok{color:var(--ok);font-weight:900}

  .topicItem{
    border:1px solid #e5e7eb;
    border-radius:14px;
    padding:12px;
    margin-top:10px;
    background:#fff;
  }
</style>
</head>

<body>

<header onclick="window.__home()">
  <div class="headerWrap">
    <div class="headerLeft">
      <button class="headerBtn" onclick="event.stopPropagation(); window.__dashboard()">Dashboard</button>
    </div>

    <div class="headerTitle">GATE EC ‚Äì Mock Test</div>

    <div class="headerRight">
      <button id="authBtn" class="headerBtn" onclick="event.stopPropagation(); window.__login()">Login</button>
    </div>
  </div>
</header>

<div class="container" id="app"></div>

<script type="module">
  // ===================== Firebase Imports =====================
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";

  import {
    getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";

  import {
    getFirestore, collection, getDocs, query, where, limit, addDoc, orderBy
  } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

  // ===================== Firebase Config =====================
  const firebaseConfig = {
    apiKey: "AIzaSyC_f6lvDO9LeSE22kv4HIhWLj846bmRla8",
    authDomain: "gate-ec-mock.firebaseapp.com",
    projectId: "gate-ec-mock",
    storageBucket: "gate-ec-mock.firebasestorage.app",
    messagingSenderId: "668980846025",
    appId: "1:668980846025:web:a960f983f2e6311fad1c18"
  };

  const firebaseApp = initializeApp(firebaseConfig);
  const auth = getAuth(firebaseApp);
  const db = getFirestore(firebaseApp);
  const provider = new GoogleAuthProvider();

  // ===================== UI ROOT =====================
  const app = document.getElementById("app");

  // ===================== USER =====================
  let currentUser = null;

  // ===================== SYLLABUS (UI LIST) =====================
  // NOTE: This is only for showing topics. Questions come from Firestore collection: "questions"
  const SYLLABUS = {
    "GA": {
      name: "General Aptitude",
      topics: [
        "Verbal Ability",
        "Numerical Ability",
        "Logical Reasoning",
        "Data Interpretation"
      ]
    },
    "Networks": {
      name: "Network Theory",
      topics: [
        "Network Theorems",
        "Transient Response",
        "AC Analysis",
        "Two Port Networks",
        "Resonance",
        "Filters"
      ]
    },
    "Signals": {
      name: "Signals & Systems",
      topics: [
        "Continuous-Time Signals",
        "Discrete-Time Signals",
        "LTI Systems",
        "Fourier Series",
        "Fourier Transform",
        "Laplace Transform",
        "Z-Transform",
        "Sampling"
      ]
    },
    "EMT": {
      name: "Electromagnetics",
      topics: [
        "Vector Calculus",
        "Electrostatics",
        "Magnetostatics",
        "Maxwell‚Äôs Equations",
        "Plane Waves",
        "Transmission Lines",
        "Waveguides"
      ]
    },
    "Analog": {
      name: "Analog Circuits",
      topics: [
        "Diodes",
        "BJT",
        "MOSFET",
        "Amplifiers",
        "Feedback",
        "Oscillators",
        "Op-Amp Applications"
      ]
    },
    "Digital": {
      name: "Digital Circuits",
      topics: [
        "Boolean Algebra",
        "Combinational Circuits",
        "Sequential Circuits",
        "FSM",
        "Memory",
        "Logic Families"
      ]
    },
    "Control": {
      name: "Control Systems",
      topics: [
        "Transfer Function",
        "Time Response",
        "Stability",
        "Root Locus",
        "Frequency Response",
        "State Space"
      ]
    },
    "Comm": {
      name: "Communications",
      topics: [
        "Analog Modulation",
        "Random Processes",
        "Digital Modulation",
        "Information Theory",
        "Channel Coding",
        "Waveguides Basics"
      ]
    },
    "EDC": {
      name: "Electronic Devices",
      topics: [
        "Semiconductors",
        "PN Junction",
        "Diode Circuits",
        "BJT Basics",
        "MOS Basics"
      ]
    }
  };

  // ===================== STATE =====================
  let currentMode = "topic"; // topic | full
  let selectedSubject = null;
  let selectedTopic = null;

  let questions = [];
  let idx = 0;
  let answers = [];
  let timer = null;
  let timeLeft = 0;

  // ===================== HELPERS =====================
  function shuffle(arr){
    const a = [...arr];
    for(let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]] = [a[j],a[i]];
    }
    return a;
  }

  function showLoading(msg="Loading..."){
    app.innerHTML = `
      <div class="card">
        <div class="loading">
          <div class="dot"></div><div class="dot"></div><div class="dot"></div>
          <div><b>${msg}</b><div class="muted">Please wait...</div></div>
        </div>
      </div>
    `;
  }

  function formatTime(sec){
    const m = Math.floor(sec/60);
    const s = sec%60;
    return ${"`"}${m}:${String(s).padStart(2,"0")}${"`"};
  }

  // ===================== HEADER AUTH BUTTON =====================
  function renderHeader(){
    const btn = document.getElementById("authBtn");
    if(!btn) return;

    if(currentUser){
      btn.innerText = "Logout";
      btn.onclick = (e)=>{ e.stopPropagation(); logout(); };
    } else {
      btn.innerText = "Login";
      btn.onclick = (e)=>{ e.stopPropagation(); login(); };
    }
  }

  // ===================== AUTH =====================
  async function login(){
    try{
      await signInWithPopup(auth, provider);
    } catch(err){
      alert("Login failed: " + err.message);
    }
  }

  async function logout(){
    try{
      await signOut(auth);
    } catch(err){
      alert("Logout failed: " + err.message);
    }
  }

  onAuthStateChanged(auth, (user) => {
    currentUser = user;
    renderHeader();
    // keep user on current page, no forced redirect
  });

  // ===================== CLOUD ATTEMPTS =====================
  async function saveAttemptCloud(data){
    if(!currentUser) return false;
    try{
      const attemptsRef = collection(db, "users", currentUser.uid, "attempts");
      await addDoc(attemptsRef, data);
      return true;
    } catch(e){
      console.log("Cloud save error:", e);
      return false;
    }
  }

  async function loadAttemptsCloud(){
    if(!currentUser) return [];
    const attemptsRef = collection(db, "users", currentUser.uid, "attempts");
    const qref = query(attemptsRef, orderBy("time", "desc"), limit(30));
    const snap = await getDocs(qref);
    return snap.docs.map(d => d.data());
  }

  // ===================== FIRESTORE QUESTIONS FETCH =====================
  async function fetchQuestions({subject=null, topic=null, maxCount=20}){
    const colRef = collection(db, "questions");
    let qRef;

    if(subject && topic){
      qRef = query(colRef, where("subject","==",subject), where("topic","==",topic), limit(500));
    } else if(subject){
      qRef = query(colRef, where("subject","==",subject), limit(500));
    } else {
      qRef = query(colRef, limit(2000));
    }

    const snap = await getDocs(qRef);

    const all = [];
    snap.forEach(doc=>{
      const d = doc.data();

      // Accept both "question" and "questions" (your DB had "Questions")
      const qText = d.question || d.questions || d.Questions || "";

      // Accept both "options" and "Options"
      const opts = d.options || d.Options || [];

      // Accept both "answer" and "Answer"
      const ans = (typeof d.answer === "number") ? d.answer : d.Answer;

      if(
        typeof d.subject === "string" &&
        typeof d.topic === "string" &&
        typeof qText === "string" &&
        Array.isArray(opts) &&
        typeof ans === "number"
      ){
        all.push({
          id: doc.id,
          subject: d.subject,
          topic: d.topic,
          question: qText,
          options: opts,
          answer: ans
        });
      }
    });

    return shuffle(all).slice(0, Math.min(maxCount, all.length));
  }

  // ===================== PAGES =====================
  function home(){
    if(timer) clearInterval(timer);

    app.innerHTML = `
      <div class="card">
        <div class="topbar">
          <div>
            <div class="pill">Beginner Friendly</div>
            <h2 style="margin:10px 0 6px 0;">Choose Practice Mode</h2>
            <div class="muted">
              ${currentUser
                ? `Logged in as <b>${currentUser.email}</b> (Cloud tracking enabled)`
                : `Guest Mode (Local tracking). Login to save progress online.`
              }
            </div>
          </div>
        </div>

        <div style="margin-top:12px" class="row">
          <div class="col card" style="margin:0">
            <h3 style="margin:0 0 6px 0;">Subject / Topic Practice</h3>
            <div class="muted">Pick subject ‚Üí topic ‚Üí attempt quiz (20 questions).</div><br/>
            <button class="btn" onclick="window.__subjects()">Start Topic Practice</button>
          </div>

          <div class="col card" style="margin:0">
            <h3 style="margin:0 0 6px 0;">Full Mock Test</h3>
            <div class="muted">Mixed questions (up to 200).</div><br/>
            <button class="btn" onclick="window.__fullMock()">Start Full Mock</button>
          </div>
        </div>

        <div class="warn" style="margin-top:12px">
          <b>Note:</b> Questions are fetched from <b>Firebase Firestore</b> collection <b>questions</b>.<br/>
          If DB has only 3 questions, you will get only 3.
        </div>
      </div>
    `;
  }

  function subjects(){
    selectedSubject = null;
    selectedTopic = null;

    let html = `<div class="card">
      <h2 style="margin:0 0 6px 0;">Select Subject</h2>
      <div class="muted">Pick subject ‚Üí view topics ‚Üí start quiz.</div>
    </div>`;

    Object.keys(SYLLABUS).forEach(code=>{
      const s = SYLLABUS[code];
      html += `
        <div class="card">
          <div class="topbar">
            <div>
              <b>${s.name}</b> <span class="pill">${code}</span><br/>
              <div class="muted">${s.topics.length} topics available</div>
            </div>
            <button class="btn light" onclick="window.__topics('${code}')">View Topics</button>
          </div>
        </div>
      `;
    });

    html += `<button class="btn secondary" onclick="window.__home()">Back</button>`;
    app.innerHTML = html;
  }

  function topics(code){
    selectedSubject = code;
    selectedTopic = null;

    const s = SYLLABUS[code];
    let html = `
      <div class="card">
        <h2 style="margin:0 0 6px 0;">${s.name} <span class="pill">${code}</span></h2>
        <div class="muted">Choose a topic to start quiz.</div>
      </div>
    `;

    s.topics.forEach(t=>{
      html += `
        <div class="topicItem">
          <b>${t}</b>
          <div style="margin-top:10px">
            <button class="btn" onclick="window.__startTopicQuiz('${code}','${t.replaceAll("'","")}')">Start Quiz</button>
          </div>
        </div>
      `;
    });

    html += `<div style="margin-top:12px">
      <button class="btn secondary" onclick="window.__subjects()">Back</button>
    </div>`;

    app.innerHTML = html;
  }

  // ===================== QUIZ ENGINE =====================
  function startQuiz(){
    idx = 0;
    answers = Array(questions.length).fill(null);

    timeLeft = questions.length * 60; // 1 min per question

    if(timer) clearInterval(timer);
    timer = setInterval(()=>{
      timeLeft--;
      if(timeLeft <= 0){
        submit();
      } else {
        renderQuiz();
      }
    }, 1000);

    renderQuiz();
  }

  function renderQuiz(){
    const q = questions[idx];

    const sideGrid = questions.map((_,i)=>{
      const answered = answers[i] !== null;
      return `<div class="qnum ${answered?'answered':''} ${i===idx?'current':''}" onclick="window.__jump(${i})">${i+1}</div>`;
    }).join("");

    app.innerHTML = `
      <div class="card">
        <div class="topbar">
          <div>
            <div class="pill">Exam Mode</div>
            <div class="muted">
              ${currentMode==="topic"
                ? `Subject: <b>${selectedSubject}</b> | Topic: <b>${selectedTopic}</b>`
                : `Full Mock (Mixed)`
              }
            </div>
          </div>
          <div class="timer">‚è≥ ${formatTime(timeLeft)}</div>
        </div>
      </div>

      <div class="row">
        <div class="col" style="flex:2">
          <div class="card">
            <div class="qbox">
              <b>Q${idx+1}/${questions.length}.</b> ${q.question}
            </div>

            <div style="margin-top:10px">
              ${q.options.map((o,i)=>`
                <div class="option ${answers[idx]===i?'selected':''}" onclick="window.__select(${i})">
                  ${o}
                </div>
              `).join("")}
            </div>

            <div class="nav">
              <button class="btn light" onclick="window.__prev()">Previous</button>
              <button class="btn light" onclick="window.__next()">Next</button>
              <button class="btn danger" onclick="window.__submit()">Submit</button>
            </div>
          </div>
        </div>

        <div class="col" style="flex:1;min-width:260px">
          <div class="card">
            <b>Question Palette</b>
            <div class="muted">Green = answered</div>
            <div class="gridQ">${sideGrid}</div>
          </div>
        </div>
      </div>
    `;
  }

  function selectOpt(i){ answers[idx] = i; renderQuiz(); }
  function prevQ(){ if(idx>0){ idx--; renderQuiz(); } }
  function nextQ(){ if(idx<questions.length-1){ idx++; renderQuiz(); } }
  function jump(i){ idx=i; renderQuiz(); }

  async function submit(){
    if(timer) clearInterval(timer);

    let score = 0;
    questions.forEach((q,i)=>{
      if(answers[i] === q.answer) score++;
    });

    const percent = Math.round((score / questions.length) * 100);

    const attemptData = {
      time: Date.now(),
      mode: currentMode === "topic"
        ? `Topic Test (${selectedSubject} - ${selectedTopic})`
        : "Full Mock Test",
      score: score,
      totalQ: questions.length,
      percent: percent
    };

    if(currentUser){
      await saveAttemptCloud(attemptData);
    } else {
      const history = JSON.parse(localStorage.getItem("gate_history") || "[]");
      history.push(attemptData);
      localStorage.setItem("gate_history", JSON.stringify(history));
    }

    app.innerHTML = `
      <div class="card">
        <h2 style="margin:0 0 6px 0;">Test Completed ‚úÖ</h2>
        <div class="muted">Your score:</div>
        <div style="font-size:22px;margin-top:6px">
          <b>${score}</b> / ${questions.length} <span class="ok">(${percent}%)</span>
        </div>

        <div style="margin-top:12px" class="row">
          <button class="btn" onclick="window.__more()">Want More Questions</button>
          <button class="btn light" onclick="window.__dashboard()">Dashboard</button>
          <button class="btn secondary" onclick="window.__home()">Home</button>
        </div>
      </div>
    `;
  }

  // ===================== STARTERS =====================
  async function startTopicQuiz(code, topic){
    currentMode = "topic";
    selectedSubject = code;
    selectedTopic = topic;

    showLoading("Loading topic questions from Firebase...");

    try{
      const fetched = await fetchQuestions({subject: code, topic, maxCount: 20});
      questions = fetched;

      if(questions.length === 0){
        app.innerHTML = `
          <div class="card">
            <h3>No questions found ‚ùå</h3>
            <div class="warn">
              Add questions in Firestore collection <b>questions</b> with fields:
              <b>subject, topic, question, options, answer</b>
            </div>
            <div style="margin-top:12px">
              <button class="btn secondary" onclick="window.__topics('${code}')">Back</button>
            </div>
          </div>
        `;
        return;
      }

      startQuiz();
    } catch(err){
      app.innerHTML = `
        <div class="card">
          <h3>Error loading questions ‚ùå</h3>
          <div class="warn">${String(err)}</div>
          <button class="btn secondary" onclick="window.__home()">Home</button>
        </div>
      `;
    }
  }

  async function fullMock(){
    currentMode = "full";
    selectedSubject = null;
    selectedTopic = null;

    showLoading("Loading full mock questions from Firebase...");

    try{
      const fetched = await fetchQuestions({subject: null, topic: null, maxCount: 200});
      questions = fetched;

      if(questions.length === 0){
        app.innerHTML = `
          <div class="card">
            <h3>No questions found ‚ùå</h3>
            <div class="warn">
              Your Firestore collection <b>questions</b> is empty.<br/>
              Add some questions first.
            </div>
            <button class="btn secondary" onclick="window.__home()">Home</button>
          </div>
        `;
        return;
      }

      startQuiz();
    } catch(err){
      app.innerHTML = `
        <div class="card">
          <h3>Error loading questions ‚ùå</h3>
          <div class="warn">${String(err)}</div>
          <button class="btn secondary" onclick="window.__home()">Home</button>
        </div>
      `;
    }
  }

  // ===================== DASHBOARD =====================
  async function dashboard(){
    showLoading("Loading dashboard...");

    let history = [];
    if(currentUser){
      history = await loadAttemptsCloud();
    } else {
      history = JSON.parse(localStorage.getItem("gate_history") || "[]").reverse();
    }

    const totalAttempts = history.length;
    const best = history.reduce((m,a)=>Math.max(m, a.percent||0), 0);

    app.innerHTML = `
      <div class="card">
        <h2 style="margin:0 0 6px 0;">Dashboard üìä</h2>
        <div class="muted">
          ${currentUser ? `User: <b>${currentUser.email}</b>` : `Guest Mode (Local tracking)`}
        </div>

        <div style="margin-top:12px" class="row">
          <div class="col card" style="margin:0">
            <b>Total Attempts</b>
            <div style="font-size:22px;margin-top:6px"><b>${totalAttempts}</b></div>
          </div>
          <div class="col card" style="margin:0">
            <b>Best %</b>
            <div style="font-size:22px;margin-top:6px"><b>${best}%</b></div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <b>Recent Attempts</b>
          <div style="margin-top:10px">
            ${
              history.length===0
              ? `<div class="muted">No attempts yet. Start a test!</div>`
              : history.slice(0,10).map(a=>`
                  <div style="padding:10px;border:1px solid #e5e7eb;border-radius:12px;margin-bottom:8px">
                    <b>${a.mode}</b><br/>
                    <span class="muted">Score: ${a.score}/${a.totalQ} | ${a.percent}%</span>
                  </div>
                `).join("")
            }
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <button class="btn" onclick="window.__home()">Home</button>
        </div>
      </div>
    `;
  }

  // ===================== MORE QUESTIONS =====================
  function more(){
    if(currentMode === "topic") startTopicQuiz(selectedSubject, selectedTopic);
    else fullMock();
  }

  // ===================== EXPOSE FUNCTIONS (IMPORTANT) =====================
  window.__home = home;
  window.__subjects = subjects;
  window.__topics = topics;
  window.__startTopicQuiz = startTopicQuiz;
  window.__fullMock = fullMock;

  window.__startQuiz = startQuiz;
  window.__select = selectOpt;
  window.__prev = prevQ;
  window.__next = nextQ;
  window.__jump = jump;
  window.__submit = submit;

  window.__more = more;
  window.__dashboard = dashboard;

  window.__login = login;
  window.__logout = logout;

  // ===================== START APP =====================
  home();
</script>

</body>
</html>