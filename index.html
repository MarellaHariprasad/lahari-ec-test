<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>GATE EC Mock Test</title>

<style>
  :root{
    --blue1:#041a3a;
    --blue2:#0b3c91;
    --blue3:#2e7bff;
    --bg:#f4f6fb;
    --card:#ffffff;
    --text:#111827;
    --muted:#6b7280;
    --danger:#d90429;
    --ok:#0a7d2f;
    --shadow:0 10px 30px rgba(0,0,0,.08);
    --radius:16px;
  }
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}

  header{
    background:radial-gradient(circle at center, #2e7bff 0%, #0b3c91 45%, #041a3a 100%);
    color:#fff;
    padding:14px 12px;
    text-align:center;
    font-weight:800;
    letter-spacing:.4px;
    cursor:pointer;
    position:sticky;top:0;z-index:10;
  }

  .headerWrap{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    max-width:980px;
    margin:0 auto;
  }

  .headerTitle{
    flex:1;
    text-align:center;
    font-size:18px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    user-select:none;
  }

  .headerBtn{
    padding:8px 12px;
    border-radius:999px;
    border:none;
    cursor:pointer;
    font-weight:800;
    background:#e7efff;
    color:#0b3c91;
    box-shadow:0 6px 16px rgba(0,0,0,.12);
  }

  .container{padding:14px;max-width:980px;margin:0 auto}
  .card{
    background:var(--card);padding:14px;margin:12px 0;border-radius:var(--radius);
    box-shadow:var(--shadow)
  }
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .col{flex:1;min-width:220px}

  .btn{
    background:var(--blue2);color:#fff;border:none;padding:10px 14px;border-radius:12px;
    cursor:pointer;font-weight:750
  }
  .btn:active{transform:scale(.98)}
  .btn.secondary{background:#111827}
  .btn.light{background:#e7efff;color:#0b3c91}
  .btn.danger{background:var(--danger)}

  .pill{
    display:inline-block;padding:6px 10px;border-radius:999px;background:#eef2ff;color:#3730a3;
    font-size:12px;font-weight:800
  }
  .muted{color:var(--muted);font-size:13px;line-height:1.4}

  .topbar{
    display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap
  }
  .timer{color:var(--danger);font-weight:900}

  .qbox{font-size:15px;line-height:1.5}
  .option{
    border:1px solid #d1d5db;padding:12px;margin:8px 0;border-radius:12px;cursor:pointer;
    background:#fff
  }
  .option.selected{background:#dbe6ff;border-color:#2e7bff}

  .nav{display:flex;justify-content:space-between;gap:10px;margin-top:12px;flex-wrap:wrap}

  .gridQ{
    display:grid;grid-template-columns:repeat(10, 1fr);gap:6px;margin-top:10px
  }
  .qnum{
    text-align:center;padding:8px;border-radius:10px;background:#f3f4f6;font-weight:800;
    cursor:pointer;font-size:12px
  }
  .qnum.answered{background:#d1fae5}
  .qnum.current{outline:2px solid #2563eb}

  .loading{display:flex;gap:10px;align-items:center}
  .dot{width:10px;height:10px;border-radius:50%;background:#2e7bff;animation:b 1s infinite}
  .dot:nth-child(2){animation-delay:.2s}
  .dot:nth-child(3){animation-delay:.4s}
  @keyframes b{0%,100%{opacity:.2}50%{opacity:1}}

  .warn{color:#92400e;background:#fffbeb;border:1px solid #fcd34d;padding:10px;border-radius:12px}
  .ok{color:var(--ok);font-weight:900}

  .miniCard{
    border:1px solid #e5e7eb;
    border-radius:14px;
    padding:12px;
    background:#fff;
  }

  .statRow{
    display:grid;
    grid-template-columns:repeat(3, 1fr);
    gap:10px;
  }
  @media(max-width:700px){
    .statRow{grid-template-columns:1fr}
  }
</style>
</head>

<body>

<header onclick="window.__home()">
  <div class="headerWrap">
    <button class="headerBtn" onclick="event.stopPropagation(); window.__dashboard()">Dashboard</button>

    <div class="headerTitle">GATE EC ‚Äì Mock Test</div>

    <button id="authBtn" class="headerBtn" onclick="event.stopPropagation(); window.__login()">Login</button>
  </div>
</header>

<div class="container" id="app"></div>

<script type="module">
  // ===================== Firebase Imports =====================
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  import {
    getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";

  import {
    getFirestore, collection, getDocs, query, where, limit, addDoc, orderBy
  } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

  // ===================== Firebase Config =====================
  const firebaseConfig = {
    apiKey: "AIzaSyC_f6lvDO9LeSE22kv4HIhWLj846bmRla8",
    authDomain: "gate-ec-mock.firebaseapp.com",
    projectId: "gate-ec-mock",
    storageBucket: "gate-ec-mock.firebasestorage.app",
    messagingSenderId: "668980846025",
    appId: "1:668980846025:web:a960f983f2e6311fad1c18"
  };

  const firebaseApp = initializeApp(firebaseConfig);
  const auth = getAuth(firebaseApp);
  const db = getFirestore(firebaseApp);
  const provider = new GoogleAuthProvider();

  // ===================== UI ROOT =====================
  const app = document.getElementById("app");

  // ===================== GLOBAL USER =====================
  let currentUser = null;

  // ===================== FULL SYLLABUS (UI ONLY) =====================
  // Note: This is ONLY for listing Subjects/Topics.
  // Questions will come from Firestore collection "questions".
  const SYLLABUS = {
    "GA": {
      name: "General Aptitude",
      overview: "Verbal + Numerical ability.",
      topics: {
        "Verbal Ability": "English comprehension, grammar, sentence correction.",
        "Numerical Ability": "Arithmetic, data interpretation, basic math."
      }
    },

    "EM": {
      name: "Engineering Mathematics",
      overview: "Core math used in EC.",
      topics: {
        "Linear Algebra": "Matrices, eigenvalues, eigenvectors.",
        "Calculus": "Limits, differentiation, integration.",
        "Differential Equations": "1st/2nd order differential equations.",
        "Probability & Statistics": "Random variables, distributions, mean/variance."
      }
    },

    "NT": {
      name: "Network Theory",
      overview: "Circuit analysis and networks.",
      topics: {
        "Circuit Laws": "KCL, KVL, basic network analysis.",
        "Network Theorems": "Thevenin, Norton, superposition, max power transfer.",
        "Transient Analysis": "RL/RC/RLC responses.",
        "Two Port Networks": "Z, Y, h, ABCD parameters."
      }
    },

    "EDC": {
      name: "Electronic Devices",
      overview: "Semiconductor devices and basics.",
      topics: {
        "Diodes": "PN junction, rectifiers, clippers, clampers.",
        "BJT": "Characteristics, biasing, amplifier basics.",
        "MOSFET": "MOS structure, characteristics.",
        "Special Devices": "LED, photodiode, etc."
      }
    },

    "AN": {
      name: "Analog Circuits",
      overview: "Amplifiers, feedback, op-amp circuits.",
      topics: {
        "Amplifiers": "Small signal models, frequency response.",
        "Feedback": "Stability, gain, bandwidth.",
        "Op-Amps": "Ideal op-amp, applications.",
        "Oscillators": "RC, LC, crystal oscillators."
      }
    },

    "DC": {
      name: "Digital Circuits",
      overview: "Logic, combinational and sequential design.",
      topics: {
        "Logic Gates": "Boolean algebra, minimization, K-map.",
        "Combinational Circuits": "Adders, Dashboard, mux/demux, encoders.",
        "Sequential Circuits": "Flip-flops, counters, registers.",
        "Memory": "ROM/RAM basics."
      }
    },

    "CS": {
      name: "Control Systems",
      overview: "Transfer functions and stability.",
      topics: {
        "Time Response": "Step response, transient and steady-state.",
        "Frequency Response": "Bode, Nyquist plots.",
        "Stability": "Routh, root locus, stability margins.",
        "State Space": "State models, controllability."
      }
    },

    "COMM": {
      name: "Communications",
      overview: "Analog + Digital communication systems.",
      topics: {
        "Analog Modulation": "AM, FM, PM.",
        "Digital Modulation": "ASK, FSK, PSK, QAM basics.",
        "Information Theory": "Entropy, channel capacity.",
        "Noise": "SNR, noise figure, probability of error."
      }
    },

    "EMFT": {
      name: "Electromagnetics",
      overview: "Fields, waves, transmission lines.",
      topics: {
        "Electrostatics": "Coulomb, Gauss law, potential.",
        "Magnetostatics": "Biot-Savart, Ampere law.",
        "Waves": "Plane waves, reflection, polarization.",
        "Transmission Lines": "Smith chart basics, impedance matching."
      }
    },

    "S&S": {
      name: "Signals & Systems",
      overview: "Signal analysis and transforms.",
      topics: {
        "LTI Systems": "Convolution, properties.",
        "Fourier Series/Transform": "Frequency domain analysis.",
        "Laplace Transform": "System analysis, ROC.",
        "Z Transform": "Discrete-time systems."
      }
    }
  };

  // ===================== APP STATE =====================
  let currentMode = "topic"; // topic | full
  let selectedSubject = null;
  let selectedTopic = null;

  let questions = [];
  let idx = 0;
  let answers = [];
  let timer = null;
  let timeLeft = 0;

  // ===================== HELPERS =====================
  function shuffle(arr){
    const a = [...arr];
    for(let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]] = [a[j],a[i]];
    }
    return a;
  }

  function showLoading(msg="Loading..."){
    app.innerHTML = `
      <div class="card">
        <div class="loading">
          <div class="dot"></div><div class="dot"></div><div class="dot"></div>
          <div><b>${msg}</b><div class="muted">Please wait...</div></div>
        </div>
      </div>
    `;
  }

  function formatTime(sec){
    const m = Math.floor(sec/60);
    const s = sec%60;
    return `${m}:${String(s).padStart(2,"0")}`;
  }

  // ===================== HEADER AUTH BUTTON =====================
  window.__renderHeader = function(){
    const btn = document.getElementById("authBtn");
    if(!btn) return;

    if(currentUser){
      btn.innerText = "Logout";
      btn.onclick = (e)=>{ e.stopPropagation(); window.__logout(); };
    } else {
      btn.innerText = "Login";
      btn.onclick = (e)=>{ e.stopPropagation(); window.__login(); };
    }
  };

  // ===================== AUTH FUNCTIONS =====================
  window.__login = async function(){
    try{
      await signInWithPopup(auth, provider);
    } catch(err){
      alert("Login failed: " + err.message);
    }
  };

  window.__logout = async function(){
    try{
      await signOut(auth);
    } catch(err){
      alert("Logout failed: " + err.message);
    }
  };

  onAuthStateChanged(auth, (user) => {
    currentUser = user;
    window.__renderHeader();
    // Always go home after login/logout
    home();
  });

  // ===================== CLOUD ATTEMPTS (FIRESTORE) =====================
  async function saveAttemptCloud(data){
    if(!currentUser) return false;
    try{
      const attemptsRef = collection(db, "users", currentUser.uid, "attempts");
      await addDoc(attemptsRef, data);
      return true;
    } catch(e){
      console.log("Cloud save error:", e);
      return false;
    }
  }

  async function loadAttemptsCloud(){
    if(!currentUser) return [];
    const attemptsRef = collection(db, "users", currentUser.uid, "attempts");
    const qref = query(attemptsRef, orderBy("time", "desc"), limit(20));
    const snap = await getDocs(qref);
    return snap.docs.map(d => d.data());
  }

  // ===================== FIRESTORE QUESTIONS FETCH =====================
  async function fetchQuestions({subject=null, topic=null, maxCount=20}){
    const colRef = collection(db, "questions");
    let qRef;

    if(subject && topic){
      qRef = query(colRef, where("subject","==",subject), where("topic","==",topic), limit(500));
    } else if(subject){
      qRef = query(colRef, where("subject","==",subject), limit(500));
    } else {
      qRef = query(colRef, limit(2000));
    }

    const snap = await getDocs(qRef);

    const all = [];
    snap.forEach(doc=>{
      const d = doc.data();
      if(
        typeof d.subject === "string" &&
        typeof d.topic === "string" &&
        typeof d.question === "string" &&
        Array.isArray(d.options) &&
        typeof d.answer === "number"
      ){
        all.push({
          id: doc.id,
          subject: d.subject,
          topic: d.topic,
          question: d.question,
          options: d.options,
          answer: d.answer
        });
      }
    });

    return shuffle(all).slice(0, Math.min(maxCount, all.length));
  }

  // ===================== PAGES =====================
  function home(){
    if(timer) clearInterval(timer);

    app.innerHTML = `
      <div class="card">
        <div class="topbar">
          <div>
            <div class="pill">Beginner Friendly</div>
            <h2 style="margin:10px 0 6px 0;">Choose Practice Mode</h2>
            <div class="muted">
              ${currentUser
                ? `Logged in as <b>${currentUser.email}</b> (Cloud tracking enabled)`
                : `Guest Mode (Local tracking). Login to save progress online.`
              }
            </div>
          </div>
        </div>

        <div style="margin-top:12px" class="row">
          <div class="col card" style="margin:0">
            <h3 style="margin:0 0 6px 0;">Subject / Topic Practice</h3>
            <div class="muted">Pick subject ‚Üí topic ‚Üí attempt quiz (20 questions).</div><br/>
            <button class="btn" onclick="window.__subjects()">Start Topic Practice</button>
          </div>

          <div class="col card" style="margin:0">
            <h3 style="margin:0 0 6px 0;">Full Mock Test</h3>
            <div class="muted">Mixed questions (up to 200).</div><br/>
            <button class="btn" onclick="window.__fullMock()">Start Full Mock</button>
          </div>
        </div>

        <div class="warn" style="margin-top:12px">
          <b>Note:</b> Questions are fetched from <b>Firebase Firestore</b> collection <b>questions</b>.
          If a topic has only 3 questions in DB, you will get only 3.
        </div>
      </div>
    `;
  }

  function subjects(){
    selectedSubject = null;
    selectedTopic = null;

    let html = `<div class="card">
      <h2 style="margin:0 0 6px 0;">Select Subject</h2>
      <div class="muted">Pick subject ‚Üí topic ‚Üí start quiz.</div>
    </div>`;

    Object.keys(SYLLABUS).forEach(code=>{
      const s = SYLLABUS[code];
      html += `
        <div class="card">
          <div class="topbar">
            <div>
              <b>${s.name}</b> <span class="pill">${code}</span><br/>
              <div class="muted">${s.overview}</div>
            </div>
            <button class="btn light" onclick="window.__topics('${code}')">View Topics</button>
          </div>
        </div>
      `;
    });

    html += `<button class="btn secondary" onclick="window.__home()">Back</button>`;
    app.innerHTML = html;
  }

  function topics(code){
    selectedSubject = code;
    selectedTopic = null;

    const s = SYLLABUS[code];
    let html = `
      <div class="card">
        <h2 style="margin:0 0 6px 0;">${s.name} <span class="pill">${code}</span></h2>
        <div class="muted">${s.overview}</div>
      </div>
    `;

    Object.keys(s.topics).forEach(t=>{
      html += `
        <div class="card">
          <b>${t}</b>
          <div class="muted" style="margin-top:6px">${s.topics[t]}</div>
          <div style="margin-top:10px">
            <button class="btn" onclick="window.__topicIntro('${code}', ${JSON.stringify(t)})">Open Topic</button>
          </div>
        </div>
      `;
    });

    html += `<button class="btn secondary" onclick="window.__subjects()">Back</button>`;
    app.innerHTML = html;
  }

  function topicIntro(code, topic){
    selectedSubject = code;
    selectedTopic = topic;

    const s = SYLLABUS[code];
    const info = s.topics[topic] || "Topic details will be added.";

    app.innerHTML = `
      <div class="card">
        <h2 style="margin:0 0 6px 0;">${s.name} ‚Üí ${topic}</h2>
        <div class="muted">${info}</div>

        <div class="warn" style="margin-top:12px">
          <b>Tip:</b> Learn basics first, then attempt quiz in exam mode.
        </div>

        <div style="margin-top:12px" class="row">
          <button class="btn" onclick="window.__startTopicQuiz('${code}', ${JSON.stringify(topic)})">Start Quiz (20 Q)</button>
          <button class="btn secondary" onclick="window.__topics('${code}')">Back</button>
        </div>
      </div>
    `;
  }

  // ===================== QUIZ ENGINE =====================
  function startQuiz(){
    idx = 0;
    answers = Array(questions.length).fill(null);

    // 1 minute per question
    timeLeft = questions.length * 60;

    if(timer) clearInterval(timer);
    timer = setInterval(()=>{
      timeLeft--;
      if(timeLeft <= 0){
        submit();
      } else {
        renderQuiz();
      }
    }, 1000);

    renderQuiz();
  }

  function renderQuiz(){
    const q = questions[idx];

    const sideGrid = questions.map((_,i)=>{
      const answered = answers[i] !== null;
      return `<div class="qnum ${answered?'answered':''} ${i===idx?'current':''}" onclick="window.__jump(${i})">${i+1}</div>`;
    }).join("");

    app.innerHTML = `
      <div class="card">
        <div class="topbar">
          <div>
            <div class="pill">GATE Exam Mode</div>
            <div class="muted">
              ${currentMode==="topic"
                ? `Subject: <b>${selectedSubject}</b> | Topic: <b>${selectedTopic}</b>`
                : `Full Mock (Mixed)`
              }
            </div>
          </div>
          <div class="timer">‚è≥ ${formatTime(timeLeft)}</div>
        </div>
      </div>

      <div class="row">
        <div class="col" style="flex:2">
          <div class="card">
            <div class="qbox">
              <b>Q${idx+1}/${questions.length}.</b> ${q.question}
            </div>
            <div style="margin-top:10px">
              ${q.options.map((o,i)=>`
                <div class="option ${answers[idx]===i?'selected':''}" onclick="window.__select(${i})">
                  ${o}
                </div>
              `).join("")}
            </div>

            <div class="nav">
              <button class="btn light" onclick="window.__prev()">Previous</button>
              <button class="btn light" onclick="window.__next()">Next</button>
              <button class="btn danger" onclick="window.__submit()">Submit</button>
            </div>
          </div>
        </div>

        <div class="col" style="flex:1;min-width:260px">
          <div class="card">
            <b>Question Palette</b>
            <div class="muted">Green = answered</div>
            <div class="gridQ">${sideGrid}</div>
          </div>
        </div>
      </div>
    `;
  }

  function selectOpt(i){ answers[idx] = i; renderQuiz(); }
  function prevQ(){ if(idx>0){ idx--; renderQuiz(); } }
  function nextQ(){ if(idx<questions.length-1){ idx++; renderQuiz(); } }
  function jump(i){ idx=i; renderQuiz(); }

  async function submit(){
    if(timer) clearInterval(timer);

    let score = 0;
    questions.forEach((q,i)=>{
      if(answers[i] === q.answer) score++;
    });

    const percent = Math.round((score / questions.length) * 100);

    const attemptData = {
      time: Date.now(),
      mode: currentMode === "topic"
        ? `Topic Test (${selectedSubject} - ${selectedTopic})`
        : "Full Mock Test",
      score: score,
      totalQ: questions.length,
      percent: percent
    };

    if(currentUser){
      await saveAttemptCloud(attemptData);
    } else {
      const history = JSON.parse(localStorage.getItem("gate_history") || "[]");
      history.push(attemptData);
      localStorage.setItem("gate_history", JSON.stringify(history));
    }

    app.innerHTML = `
      <div class="card">
        <h2 style="margin:0 0 6px 0;">Test Completed ‚úÖ</h2>
        <div class="muted">Your score:</div>
        <div style="font-size:22px;margin-top:6px">
          <b>${score}</b> / ${questions.length} <span class="ok">(${percent}%)</span>
        </div>

        <div class="warn" style="margin-top:12px">
          <b>Want more questions?</b><br/>
          We will fetch a new random set from Firebase.
          If your DB has limited questions, it may repeat.
        </div>

        <div style="margin-top:12px" class="row">
          <button class="btn" onclick="window.__more()">Want More Questions</button>
          <button class="btn light" onclick="window.__dashboard()">Dashboard</button>
          <button class="btn secondary" onclick="window.__home()">Home</button>
        </div>
      </div>
    `;
  }

  // ===================== STARTERS =====================
  async function startTopicQuiz(code, topic){
    currentMode = "topic";
    selectedSubject = code;
    selectedTopic = topic;

    showLoading("Loading topic questions from Firebase...");

    try{
      const fetched = await fetchQuestions({subject: code, topic, maxCount: 20});
      questions = fetched;

      if(questions.length === 0){
        app.innerHTML = `
          <div class="card">
            <h3>No questions found ‚ùå</h3>
            <div class="warn">
              Add questions in Firestore collection <b>questions</b> with fields:
              <b>subject, topic, question, options, answer</b>
            </div>
            <div style="margin-top:12px">
              <button class="btn secondary" onclick="window.__topicIntro('${code}', ${JSON.stringify(topic)})">Back</button>
            </div>
          </div>
        `;
        return;
      }

      startQuiz();
    } catch(err){
      app.innerHTML = `
        <div class="card">
          <h3>Error loading questions ‚ùå</h3>
          <div class="warn">${String(err)}</div>
          <button class="btn secondary" onclick="window.__home()">Home</button>
        </div>
      `;
    }
  }

  async function fullMock(){
    currentMode = "full";
    selectedSubject = null;
    selectedTopic = null;

    showLoading("Loading full mock questions from Firebase...");

    try{
      const fetched = await fetchQuestions({subject: null, topic: null, maxCount: 200});
      questions = fetched;

      if(questions.length === 0){
        app.innerHTML = `
          <div class="card">
            <h3>No questions found ‚ùå</h3>
            <div class="warn">
              Your Firestore collection <b>questions</b> is empty.
              Add questions first.
            </div>
            <button class="btn secondary" onclick="window.__home()">Home</button>
          </div>
        `;
        return;
      }

      startQuiz();
    } catch(err){
      app.innerHTML = `
        <div class="card">
          <h3>Error loading full mock ‚ùå</h3>
          <div class="warn">${String(err)}</div>
          <button class="btn secondary" onclick="window.__home()">Home</button>
        </div>
      `;
    }
  }

  // ===================== DASHBOARD =====================
  async function dashboard(){
    showLoading("Loading dashboard...");

    let attempts = [];
    if(currentUser){
      attempts = await loadAttemptsCloud();
    } else {
      attempts = JSON.parse(localStorage.getItem("gate_history") || "[]").reverse().slice(0,20);
    }

    const totalTests = attempts.length;
    const avg = totalTests ? Math.round(attempts.reduce((a,b)=>a+(b.percent||0),0)/totalTests) : 0;
    const best = totalTests ? Math.max(...attempts.map(a=>a.percent||0)) : 0;

    let listHtml = "";
    if(totalTests === 0){
      listHtml = `<div class="warn">No tests attempted yet. Start a quiz to see results here.</div>`;
    } else {
      listHtml = attempts.map(a=>{
        const dt = new Date(a.time);
        return `
          <div class="miniCard" style="margin-top:10px">
            <b>${a.mode}</b><br/>
            <div class="muted">${dt.toLocaleString()}</div>
            <div style="margin-top:6px;font-size:16px">
              Score: <b>${a.score}</b>/${a.totalQ} ‚Äî <span class="ok">${a.percent}%</span>
            </div>
          </div>
        `;
      }).join("");
    }

    app.innerHTML = `
      <div class="card">
        <h2 style="margin:0 0 6px 0;">Dashboard üìä</h2>
        <div class="muted">
          ${currentUser ? "Cloud saved progress (Logged in)" : "Local saved progress (Guest)"}
        </div>

        <div class="statRow" style="margin-top:12px">
          <div class="miniCard"><b>Total Tests</b><div style="font-size:20px;margin-top:6px">${totalTests}</div></div>
          <div class="miniCard"><b>Average %</b><div style="font-size:20px;margin-top:6px">${avg}%</div></div>
          <div class="miniCard"><b>Best %</b><div style="font-size:20px;margin-top:6px">${best}%</div></div>
        </div>

        <div style="margin-top:14px">
          <b>Recent Attempts</b>
          ${listHtml}
        </div>

        <div style="margin-top:12px" class="row">
          <button class="btn" onclick="window.__home()">Home</button>
          <button class="btn light" onclick="window.__subjects()">Topic Practice</button>
        </div>
      </div>
    `;
  }

  // ===================== MORE QUESTIONS =====================
  async function moreQuestions(){
    if(currentMode === "topic"){
      await startTopicQuiz(selectedSubject, selectedTopic);
    } else {
      await fullMock();
    }
  }

  // ===================== EXPOSE FUNCTIONS =====================
  window.__home = home;
  window.__subjects = subjects;
  window.__topics = topics;
  window.__topicIntro = topicIntro;
  window.__startTopicQuiz = startTopicQuiz;
  window.__fullMock = fullMock;

  window.__startQuiz = startQuiz;
  window.__select = selectOpt;
  window.__prev = prevQ;
  window.__next = nextQ;
  window.__jump = jump;
  window.__submit = submit;

  window.__dashboard = dashboard;
  window.__more = moreQuestions;

  // ===================== INITIAL LOAD =====================
  window.__renderHeader();
  home();
</script>

</body>
</html>