<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GATE EC - Mock Test</title>

  <style>
    :root{
      --blue1:#0a2a6a;
      --blue2:#1f63d3;
      --card:#ffffff;
      --bg:#f4f7ff;
      --text:#0b1220;
      --muted:#6b7280;
      --shadow:0 10px 30px rgba(0,0,0,0.08);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: var(--bg);
      color: var(--text);
    }

    header{
      position: sticky;
      top:0;
      z-index:10;
      background: linear-gradient(90deg, var(--blue1), var(--blue2), var(--blue1));
      padding: 14px 14px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      max-width: 980px;
      margin:0 auto;
    }
    .pillbtn{
      border:none;
      padding:10px 14px;
      border-radius: 999px;
      background: rgba(255,255,255,0.92);
      color: #0b2a66;
      font-weight:700;
      cursor:pointer;
      min-width:92px;
    }
    .title{
      color:white;
      font-weight:900;
      letter-spacing:0.4px;
      font-size:18px;
      text-align:center;
      flex:1;
    }

    .wrap{
      max-width: 980px;
      margin: 16px auto;
      padding: 0 14px 30px;
    }

    .card{
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
      margin-bottom: 14px;
    }

    .tag{
      display:inline-block;
      padding:6px 12px;
      border-radius:999px;
      background:#eef3ff;
      color:#2b4da5;
      font-weight:800;
      font-size:13px;
      margin-bottom:10px;
    }

    h1{
      margin:0;
      font-size: 30px;
      line-height: 1.15;
    }
    .subline{
      margin-top:6px;
      color: var(--muted);
      font-weight:600;
    }

    .list{
      display:flex;
      flex-direction:column;
      gap:12px;
      margin-top: 14px;
    }
    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 14px;
      border-radius: 16px;
      background: #ffffff;
      box-shadow: 0 8px 22px rgba(0,0,0,0.06);
    }
    .row-left{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .row-title{
      font-size: 18px;
      font-weight: 900;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .chip{
      font-size: 12px;
      font-weight: 900;
      padding: 6px 10px;
      border-radius: 999px;
      background: #eef3ff;
      color:#243b88;
    }
    .row-desc{
      color: var(--muted);
      font-weight:600;
      font-size: 14px;
    }
    .openbtn{
      border:none;
      padding: 10px 16px;
      border-radius: 999px;
      background:#eaf1ff;
      color:#0b2a66;
      font-weight:900;
      cursor:pointer;
      min-width:88px;
    }

    .sectionTitle{
      font-weight: 900;
      font-size: 20px;
      margin: 0 0 10px;
    }

    .topicBox{
      padding: 14px;
      border-radius: 16px;
      background:#fff;
      box-shadow: 0 8px 22px rgba(0,0,0,0.06);
      margin-bottom: 12px;
    }
    .topicName{
      font-weight: 900;
      font-size: 18px;
      margin: 0 0 6px;
    }
    .topicOverview{
      color: var(--muted);
      font-weight: 650;
      margin: 0 0 10px;
      line-height: 1.35;
    }
    .subtopics{
      margin: 0;
      padding-left: 18px;
      color:#1f2937;
      font-weight:700;
    }
    .subtopics li{
      margin: 6px 0;
      color:#374151;
      font-weight:700;
    }

    .actionRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 10px;
    }
    .primary{
      border:none;
      padding: 12px 16px;
      border-radius: 14px;
      background: linear-gradient(90deg, #0a2a6a, #1f63d3);
      color:white;
      font-weight:900;
      cursor:pointer;
    }
    .secondary{
      border:none;
      padding: 12px 16px;
      border-radius: 14px;
      background: #0f172a;
      color:white;
      font-weight:900;
      cursor:pointer;
    }

    .qcard{
      background:#fff;
      border-radius: 18px;
      padding: 16px;
      box-shadow: var(--shadow);
    }
    .qmeta{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
      color: var(--muted);
      font-weight:800;
      font-size: 13px;
    }
    .qtext{
      font-weight:900;
      font-size:18px;
      margin: 6px 0 12px;
      line-height:1.3;
    }
    .opt{
      width:100%;
      text-align:left;
      border:none;
      padding: 12px 12px;
      border-radius: 14px;
      background:#f3f6ff;
      margin-bottom: 10px;
      font-weight:800;
      cursor:pointer;
    }
    .opt.correct{ background:#e9fff1; }
    .opt.wrong{ background:#ffecec; }

    .footerBtns{
      display:flex;
      gap:10px;
      margin-top: 12px;
      flex-wrap:wrap;
    }

    .center{
      text-align:center;
      color: var(--muted);
      font-weight:800;
      padding: 12px 0;
    }

    .hidden{ display:none !important; }

    .smallNote{
      color: var(--muted);
      font-weight:700;
      font-size: 13px;
      margin-top: 6px;
    }
  </style>
</head>

<body>
  <header>
    <div class="topbar">
      <button class="pillbtn" id="btnHome">Dashboard</button>
      <div class="title">GATE EC - Mock Test</div>
      <button class="pillbtn" id="btnLogin">Login</button>
    </div>
  </header>

  <div class="wrap">

    <!-- LOGIN SCREEN -->
    <div class="card hidden" id="screenLogin">
      <span class="tag">Account</span>
      <h1>Login</h1>
      <div class="subline">Sign in using Google to save progress later.</div>
      <div class="actionRow" style="margin-top:14px;">
        <button class="primary" id="btnGoogleLogin">Sign in with Google</button>
        <button class="secondary" id="btnBackFromLogin">Back</button>
      </div>
      <div class="smallNote">
        ⚠️ If login shows “disallowed_useragent”, open in Chrome or GitHub Pages.
      </div>
    </div>

    <!-- DASHBOARD -->
    <div class="card" id="screenDashboard">
      <span class="tag">Beginner Friendly</span>
      <h1>Select Subject</h1>
      <div class="subline">Subject → Topic → Overview → Quiz</div>

      <div class="list" id="subjectList"></div>
      <div class="center" id="dashMsg"></div>
    </div>

    <!-- TOPICS -->
    <div class="card hidden" id="screenTopics">
      <h2 class="sectionTitle" id="topicsTitle">Topics</h2>
      <div class="subline" id="topicsSubline">Loading topics from Firebase...</div>
      <div style="height:12px"></div>
      <div id="topicsList"></div>
      <div class="footerBtns">
        <button class="secondary" id="btnBackToDashboard">Back</button>
      </div>
    </div>

    <!-- QUIZ -->
    <div class="card hidden" id="screenQuiz">
      <h2 class="sectionTitle" id="quizTitle">Quiz</h2>
      <div class="subline" id="quizSubline">Answer the questions</div>
      <div style="height:12px"></div>

      <div class="qcard" id="quizBox"></div>

      <div class="footerBtns">
        <button class="secondary" id="btnQuitQuiz">Back</button>
      </div>
    </div>

  </div>

  <!-- Firebase + App Logic -->
  <script type="module">
    // Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, collection, getDocs, query, where, limit
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    // Your Firebase config (from you)
    const firebaseConfig = {
      apiKey: "AIzaSyC_f6lvDO9LeSE22kv4HIhWLj846bmRla8",
      authDomain: "gate-ec-mock.firebaseapp.com",
      projectId: "gate-ec-mock",
      storageBucket: "gate-ec-mock.firebasestorage.app",
      messagingSenderId: "668980846025",
      appId: "1:668980846025:web:a960f983f2e6311fad1c18"
    };

    // Init
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Screens
    const screenLogin = document.getElementById("screenLogin");
    const screenDashboard = document.getElementById("screenDashboard");
    const screenTopics = document.getElementById("screenTopics");
    const screenQuiz = document.getElementById("screenQuiz");

    // Header buttons
    const btnHome = document.getElementById("btnHome");
    const btnLogin = document.getElementById("btnLogin");

    // Login buttons
    const btnGoogleLogin = document.getElementById("btnGoogleLogin");
    const btnBackFromLogin = document.getElementById("btnBackFromLogin");

    // Dashboard
    const subjectList = document.getElementById("subjectList");
    const dashMsg = document.getElementById("dashMsg");

    // Topics
    const topicsTitle = document.getElementById("topicsTitle");
    const topicsSubline = document.getElementById("topicsSubline");
    const topicsList = document.getElementById("topicsList");
    const btnBackToDashboard = document.getElementById("btnBackToDashboard");

    // Quiz
    const quizTitle = document.getElementById("quizTitle");
    const quizSubline = document.getElementById("quizSubline");
    const quizBox = document.getElementById("quizBox");
    const btnQuitQuiz = document.getElementById("btnQuitQuiz");

    // State
    let currentSubject = null;
    let currentTopic = null;
    let quizQuestions = [];
    let quizIndex = 0;
    let score = 0;
    let answered = false;

    // Subjects (static list, topics will come from Firebase)
    const SUBJECTS = [
      { code: "GA", name: "General Aptitude", desc: "Verbal + Numerical ability." },
      { code: "EM", name: "Engineering Mathematics", desc: "Core math used in EC." },
      { code: "NT", name: "Network Theory", desc: "Circuit analysis and networks." },
      { code: "EDC", name: "Electronic Devices", desc: "Semiconductor devices and basics." },
      { code: "AN", name: "Analog Circuits", desc: "Amplifiers, feedback, op-amp circuits." },
      { code: "DC", name: "Digital Circuits", desc: "Logic, combinational and sequential design." },
      { code: "CS", name: "Control Systems", desc: "Transfer functions and stability." },
      { code: "COMM", name: "Communications", desc: "Analog + Digital communication systems." },
      { code: "EMFT", name: "Electromagnetics", desc: "Fields, waves, transmission lines." },
      { code: "SS", name: "Signals & Systems", desc: "Signal analysis and transforms." }
    ];

    // Navigation helpers
    function hideAllScreens(){
      screenLogin.classList.add("hidden");
      screenDashboard.classList.add("hidden");
      screenTopics.classList.add("hidden");
      screenQuiz.classList.add("hidden");
    }

    function goTo(screenName, push=true){
      hideAllScreens();

      if(screenName === "dashboard") screenDashboard.classList.remove("hidden");
      if(screenName === "login") screenLogin.classList.remove("hidden");
      if(screenName === "topics") screenTopics.classList.remove("hidden");
      if(screenName === "quiz") screenQuiz.classList.remove("hidden");

      if(push){
        history.pushState({screen: screenName}, "", "#"+screenName);
      }
    }

    // Back button fix (mobile)
    window.addEventListener("popstate", (e) => {
      const st = e.state?.screen || "dashboard";
      goTo(st, false);
    });

    // Header actions
    btnHome.addEventListener("click", ()=> goTo("dashboard"));
    btnLogin.addEventListener("click", ()=> goTo("login"));

    btnBackFromLogin.addEventListener("click", ()=> goTo("dashboard"));

    // Auth UI update
    function setLoginButton(user){
      if(user){
        btnLogin.textContent = "Logout";
        btnLogin.onclick = async () => {
          await signOut(auth);
          goTo("dashboard");
        };
      }else{
        btnLogin.textContent = "Login";
        btnLogin.onclick = () => goTo("login");
      }
    }

    onAuthStateChanged(auth, (user)=>{
      setLoginButton(user);
    });

    // Google login
    btnGoogleLogin.addEventListener("click", async ()=>{
      try{
        const provider = new GoogleAuthProvider();
        await signInWithPopup(auth, provider);
        goTo("dashboard");
      }catch(err){
        alert("Login failed: " + (err?.message || err));
      }
    });

    // Render Dashboard subjects
    function renderSubjects(){
      subjectList.innerHTML = "";
      dashMsg.textContent = "";

      SUBJECTS.forEach(s=>{
        const div = document.createElement("div");
        div.className = "row";
        div.innerHTML = `
          <div class="row-left">
            <div class="row-title">${s.name} <span class="chip">${s.code}</span></div>
            <div class="row-desc">${s.desc}</div>
          </div>
          <button class="openbtn">Open</button>
        `;
        div.querySelector("button").addEventListener("click", ()=>{
          openSubjectTopics(s.code, s.name);
        });
        subjectList.appendChild(div);
      });
    }

    // Load topics from Firestore collection: topics
    async function openSubjectTopics(subjectCode, subjectName){
      currentSubject = subjectCode;
      topicsTitle.textContent = `${subjectName} (${subjectCode}) - Topics`;
      topicsSubline.textContent = "Loading topics from Firebase...";
      topicsList.innerHTML = "";
      goTo("topics");

      try{
        const q1 = query(collection(db, "topics"), where("subject", "==", subjectCode));
        const snap = await getDocs(q1);

        if(snap.empty){
          topicsSubline.textContent = "No topics found in Firebase for this subject.";
          return;
        }

        topicsSubline.textContent = "Tap a topic to view overview + start quiz.";

        const docs = [];
        snap.forEach(d=> docs.push({ id: d.id, ...d.data() }));

        // sort by topic name
        docs.sort((a,b)=> (a.topic||"").localeCompare(b.topic||""));

        docs.forEach(t=>{
          const topicName = t.topic || "Unnamed Topic";
          const overview = t.overview || "Overview not added yet.";
          const subtopics = Array.isArray(t.subtopics) ? t.subtopics : [];

          const box = document.createElement("div");
          box.className = "topicBox";
          box.innerHTML = `
            <div class="topicName">${topicName}</div>
            <div class="topicOverview">${overview}</div>
            <div style="font-weight:900; margin:10px 0 6px;">Subtopics</div>
            <ul class="subtopics">
              ${subtopics.length ? subtopics.map(x=>`<li>${x}</li>`).join("") : `<li>Subtopics not added yet.</li>`}
            </ul>
            <div class="actionRow">
              <button class="primary">Start Quiz</button>
            </div>
          `;

          box.querySelector(".primary").addEventListener("click", ()=>{
            startQuiz(subjectCode, topicName);
          });

          topicsList.appendChild(box);
        });

      }catch(err){
        topicsSubline.textContent = "Error loading topics.";
        alert("Topics error: " + (err?.message || err));
      }
    }

    // Load questions from Firestore collection: questions
    async function startQuiz(subjectCode, topicName){
      currentTopic = topicName;
      quizTitle.textContent = `${subjectCode} - ${topicName}`;
      quizSubline.textContent = "Loading questions...";
      quizBox.innerHTML = "";
      goTo("quiz");

      try{
        const q2 = query(
          collection(db, "questions"),
          where("subject", "==", subjectCode),
          where("topic", "==", topicName),
          limit(50)
        );

        const snap = await getDocs(q2);

        if(snap.empty){
          quizSubline.textContent = "No questions found in Firebase for this topic.";
          quizBox.innerHTML = `<div class="center">Add questions using upload.html</div>`;
          return;
        }

        quizQuestions = [];
        snap.forEach(d=>{
          quizQuestions.push({ id: d.id, ...d.data() });
        });

        // shuffle
        quizQuestions.sort(()=> Math.random() - 0.5);

        quizIndex = 0;
        score = 0;
        answered = false;

        quizSubline.textContent = "Answer the questions (MCQ).";
        renderQuestion();

      }catch(err){
        quizSubline.textContent = "Error loading questions.";
        alert("Quiz error: " + (err?.message || err));
      }
    }

    function renderQuestion(){
      answered = false;

      const q = quizQuestions[quizIndex];
      const total = quizQuestions.length;

      const qText = q.question || "Question missing";
      const opts = Array.isArray(q.options) ? q.options : [];
      const ans = Number(q.answer);

      quizBox.innerHTML = `
        <div class="qmeta">
          <div>Q ${quizIndex+1} / ${total}</div>
          <div>Score: ${score}</div>
        </div>
        <div class="qtext">${qText}</div>
        <div id="optWrap"></div>
        <div class="footerBtns">
          <button class="secondary" id="btnPrev" ${quizIndex===0 ? "disabled" : ""}>Prev</button>
          <button class="primary" id="btnNext">${quizIndex === total-1 ? "Finish" : "Next"}</button>
        </div>
      `;

      const optWrap = document.getElementById("optWrap");

      opts.forEach((op, i)=>{
        const b = document.createElement("button");
        b.className = "opt";
        b.textContent = (i+1) + ") " + op;

        b.addEventListener("click", ()=>{
          if(answered) return;
          answered = true;

          if(i === ans){
            b.classList.add("correct");
            score++;
          }else{
            b.classList.add("wrong");
            // mark correct one
            const correctBtn = optWrap.querySelectorAll(".opt")[ans];
            if(correctBtn) correctBtn.classList.add("correct");
          }
        });

        optWrap.appendChild(b);
      });

      document.getElementById("btnPrev").addEventListener("click", ()=>{
        if(quizIndex>0){
          quizIndex--;
          renderQuestion();
        }
      });

      document.getElementById("btnNext").addEventListener("click", ()=>{
        if(quizIndex < total-1){
          quizIndex++;
          renderQuestion();
        }else{
          showResult();
        }
      });
    }

    function showResult(){
      quizBox.innerHTML = `
        <div class="center" style="font-size:18px; font-weight:900; color:#0b1220;">
          Quiz Completed ✅
        </div>
        <div class="center">
          Subject: <b>${currentSubject}</b><br/>
          Topic: <b>${currentTopic}</b><br/><br/>
          Final Score: <b>${score}</b> / <b>${quizQuestions.length}</b>
        </div>
        <div class="footerBtns" style="justify-content:center;">
          <button class="primary" id="btnRestart">Restart</button>
          <button class="secondary" id="btnBackTopics">Back to Topics</button>
        </div>
      `;

      document.getElementById("btnRestart").addEventListener("click", ()=>{
        quizIndex = 0;
        score = 0;
        renderQuestion();
      });

      document.getElementById("btnBackTopics").addEventListener("click", ()=>{
        goTo("topics");
      });
    }

    btnBackToDashboard.addEventListener("click", ()=> goTo("dashboard"));
    btnQuitQuiz.addEventListener("click", ()=> goTo("topics"));

    // Boot
    renderSubjects();
    goTo("dashboard", false);
    history.replaceState({screen:"dashboard"}, "", "#dashboard");
  </script>
</body>
</html>